import{D as Q,E as G,r as x,y as C,R as H,p as e,aH as U,Q as D,a2 as B,O as f}from"./index-QHzcgHe1.js";import{A as K}from"./react-select-async.esm-CZqzzsXa.js";import{u as W}from"./chartOfAccountsApi-CmNpcq75.js";import{T as X}from"./trash-2-G7GOGhVq.js";import{P as Y}from"./plus-wthIFHeq.js";import{S as Z}from"./save-CQRiczmt.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=Q("RefreshCcw",[["path",{d:"M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"14sxne"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16",key:"1hlbsb"}],["path",{d:"M16 16h5v5",key:"ccwih5"}]]),te=G.injectEndpoints({endpoints:m=>({getJournalVouchers:m.query({query:i=>({url:"journal-vouchers",method:"get",params:i}),providesTags:i=>{var l,u;return(l=i==null?void 0:i.data)!=null&&l.vouchers||i!=null&&i.vouchers?[...(((u=i.data)==null?void 0:u.vouchers)||i.vouchers).map(({_id:h,id:k})=>({type:"JournalVouchers",id:h||k})),{type:"JournalVouchers",id:"LIST"}]:[{type:"JournalVouchers",id:"LIST"}]}}),getJournalVoucher:m.query({query:i=>({url:`journal-vouchers/${i}`,method:"get"}),providesTags:(i,l,u)=>[{type:"JournalVouchers",id:u}]}),createJournalVoucher:m.mutation({query:i=>({url:"journal-vouchers",method:"post",data:i}),invalidatesTags:[{type:"JournalVouchers",id:"LIST"}]})}),overrideExisting:!1}),{useGetJournalVouchersQuery:ae,useCreateJournalVoucherMutation:se}=te,A=()=>new Date().toISOString().split("T")[0],j=()=>({accountId:"",debit:"",credit:"",particulars:""}),de=()=>{const[m,i]=x.useState({fromDate:A(),toDate:A(),search:""}),[l,u]=x.useState({voucherDate:A(),reference:"",description:"",notes:"",entries:[j(),j()]}),[h,k]=x.useState(new Map),b=x.useCallback(t=>{var a;return((a=t==null?void 0:t.data)==null?void 0:a.accounts)||(t==null?void 0:t.accounts)||(t==null?void 0:t.data)||t||[]},[]),N=x.useCallback(t=>{k(a=>{const s=new Map(a);return t.forEach(r=>{s.set(r._id,r)}),s})},[]),{data:y,isLoading:T,isFetching:F}=W({includePartyAccounts:!0},{onError:t=>{C(t,"Chart of Accounts")}});H.useEffect(()=>{y&&N(b(y))},[y,b,N]);const M=x.useMemo(()=>{const t=Array.from(h.values()).reduce((a,s)=>{let r;if(Array.isArray(s.tags)&&s.tags.includes("customer"))r="Customer Accounts";else if(Array.isArray(s.tags)&&s.tags.includes("supplier"))r="Supplier Accounts";else{const o=s.accountType||"other";r=`${o.charAt(0).toUpperCase()}${o.slice(1)} Accounts`}return a[r]||(a[r]=[]),a[r].push(s),a},{});return Object.entries(t).map(([a,s])=>({label:a,options:s.sort((r,o)=>r.accountCode.localeCompare(o.accountCode)).map(r=>({value:r._id,label:`${r.accountCode} — ${r.accountName}`}))}))},[h]),$=x.useCallback(async t=>{const a=(t==null?void 0:t.trim())||"";try{const s=b(y),r=a?s.filter(d=>{var c,n;return((c=d.accountCode)==null?void 0:c.toLowerCase().includes(a.toLowerCase()))||((n=d.accountName)==null?void 0:n.toLowerCase().includes(a.toLowerCase()))}):s;N(r);const o=r.reduce((d,c)=>{let n;if(Array.isArray(c.tags)&&c.tags.includes("customer"))n="Customer Accounts";else if(Array.isArray(c.tags)&&c.tags.includes("supplier"))n="Supplier Accounts";else{const w=c.accountType||"other";n=`${w.charAt(0).toUpperCase()}${w.slice(1)} Accounts`}return d[n]||(d[n]=[]),d[n].push(c),d},{});return Object.entries(o).map(([d,c])=>({label:d,options:c.sort((n,w)=>n.accountCode.localeCompare(w.accountCode)).map(n=>({value:n._id,label:`${n.accountCode} — ${n.accountName}`}))}))}catch(s){return C(s,"Chart of Accounts"),[]}},[b,N,y]),{data:p,isLoading:E,isFetching:O}=ae({...m,page:1,limit:25},{onError:t=>{C(t,"Journal Vouchers")}}),[R,{isLoading:V}]=se(),q=async t=>{try{await R(t).unwrap(),f.success("Journal voucher created successfully"),I()}catch(a){C(a,"Create Journal Voucher")}},I=()=>{u({voucherDate:A(),reference:"",description:"",notes:"",entries:[j(),j()]})},g=x.useMemo(()=>{const t=l.entries.reduce((r,o)=>r+(parseFloat(o.debit)||0),0),a=l.entries.reduce((r,o)=>r+(parseFloat(o.credit)||0),0),s=Math.round((t-a)*100)/100;return{debitTotal:Math.round(t*100)/100,creditTotal:Math.round(a*100)/100,difference:s}},[l.entries]),v=(t,a,s)=>{u(r=>{const o=r.entries.map((d,c)=>{if(c!==t)return d;const n={...d,[a]:s};return a==="debit"&&s?n.credit="":a==="credit"&&s&&(n.debit=""),n});return{...r,entries:o}})},_=()=>{u(t=>({...t,entries:[...t.entries,j()]}))},z=t=>{u(a=>a.entries.length<=2?(f.error("At least two entries are required for a journal voucher."),a):{...a,entries:a.entries.filter((s,r)=>r!==t)})},P=t=>{var r,o,d;if(t.preventDefault(),g.debitTotal<=0){f.error("Total debit must be greater than zero.");return}if(Math.abs(g.difference)>.01){f.error("Total debit and credit must be equal before saving.");return}const a={voucherDate:l.voucherDate,reference:((r=l.reference)==null?void 0:r.trim())||void 0,description:((o=l.description)==null?void 0:o.trim())||void 0,notes:((d=l.notes)==null?void 0:d.trim())||void 0,entries:l.entries.map(c=>{var n;return{accountId:c.accountId,particulars:((n=c.particulars)==null?void 0:n.trim())||"",debit:c.debit?parseFloat(c.debit):0,credit:c.credit?parseFloat(c.credit):0}})};if(a.entries.find(c=>!c.accountId||c.debit<=0&&c.credit<=0)){f.error("Each entry must include an account and either a debit or credit amount.");return}q(a)},S=(t,a)=>{i(s=>({...s,[t]:a}))},L=(p==null?void 0:p.vouchers)||[],J=p==null?void 0:p.pagination;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Journal Vouchers"}),e.jsx("p",{className:"text-gray-600",children:"Record manual ledger adjustments while keeping debits and credits balanced."})]}),e.jsxs("button",{type:"button",onClick:I,className:"btn btn-secondary flex items-center gap-2",children:[e.jsx(ee,{className:"h-4 w-4"}),"Reset Form"]})]}),e.jsx("form",{onSubmit:P,className:"card",children:e.jsxs("div",{className:"card-content space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Voucher Date"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx("input",{type:"date",value:l.voucherDate,onChange:t=>u(a=>({...a,voucherDate:t.target.value})),className:"input pl-10",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reference"}),e.jsx("input",{type:"text",value:l.reference,onChange:t=>u(a=>({...a,reference:t.target.value})),className:"input",placeholder:"Optional reference number",maxLength:100})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("input",{type:"text",value:l.description,onChange:t=>u(a=>({...a,description:t.target.value})),className:"input",placeholder:"Purpose of this journal voucher",maxLength:1e3})]})]}),F&&e.jsxs("div",{className:"text-sm text-gray-500 flex items-center gap-2",children:[e.jsx(D,{size:"sm",inline:!0}),"Fetching accounts..."]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Account"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Particulars"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Debit"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Credit"}),e.jsx("th",{className:"px-4 py-3"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:l.entries.map((t,a)=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"space-y-2",children:e.jsx(K,{cacheOptions:!0,defaultOptions:M,loadOptions:$,value:t.accountId&&h.has(t.accountId)?{value:t.accountId,label:`${h.get(t.accountId).accountCode} — ${h.get(t.accountId).accountName}`}:null,onChange:s=>v(a,"accountId",s?s.value:""),isLoading:T||F,placeholder:"Select account",styles:{control:s=>({...s,minHeight:"2.5rem"}),menu:s=>({...s,zIndex:20})},isClearable:!0})})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("input",{type:"text",value:t.particulars,onChange:s=>v(a,"particulars",s.target.value),className:"input w-full min-w-[220px]",placeholder:"Narration / memo",maxLength:500})}),e.jsx("td",{className:"px-4 py-3 w-28",children:e.jsx("input",{type:"number",min:"0",step:"0.01",value:t.debit,onChange:s=>v(a,"debit",s.target.value),className:"input text-right w-full min-w-[90px]",placeholder:"0.00"})}),e.jsx("td",{className:"px-4 py-3 w-28",children:e.jsx("input",{type:"number",min:"0",step:"0.01",value:t.credit,onChange:s=>v(a,"credit",s.target.value),className:"input text-right w-full min-w-[90px]",placeholder:"0.00"})}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsx("button",{type:"button",onClick:()=>z(a),className:"text-red-500 hover:text-red-700","aria-label":"Remove line",children:e.jsx(X,{className:"h-4 w-4"})})})]},a))}),e.jsxs("tfoot",{className:"bg-gray-50",children:[e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-3",children:e.jsxs("button",{type:"button",onClick:_,className:"btn btn-secondary btn-sm flex items-center gap-2",children:[e.jsx(Y,{className:"h-4 w-4"}),"Add Line"]})}),e.jsx("td",{className:"px-4 py-3 text-right font-medium text-gray-700",children:"Totals"}),e.jsx("td",{className:"px-4 py-3 text-right font-semibold text-gray-900",children:g.debitTotal.toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-right font-semibold text-gray-900",children:g.creditTotal.toFixed(2)}),e.jsx("td",{className:"px-4 py-3"})]}),e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"px-4 pb-3 text-right",children:e.jsxs("span",{className:`text-sm font-medium ${Math.abs(g.difference)<.01?"text-green-600":"text-red-600"}`,children:["Difference: ",g.difference.toFixed(2)]})})})]})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("textarea",{value:l.notes,onChange:t=>u(a=>({...a,notes:t.target.value})),className:"input",rows:3,placeholder:"Optional notes or supporting details"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"submit",className:"btn btn-primary flex items-center gap-2",disabled:V||T,children:V?e.jsxs(e.Fragment,{children:[e.jsx(D,{size:"sm",inline:!0,className:"mr-2"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-4 w-4"}),"Save Voucher"]})})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"card-content",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 w-full",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"From Date"}),e.jsx("input",{type:"date",value:m.fromDate,onChange:t=>S("fromDate",t.target.value),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"To Date"}),e.jsx("input",{type:"date",value:m.toDate,onChange:t=>S("toDate",t.target.value),className:"input"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Search"}),e.jsx("input",{type:"text",value:m.search,onChange:t=>S("search",t.target.value),className:"input",placeholder:"Voucher no, account, description..."})]})]}),e.jsxs("button",{type:"button",onClick:()=>queryClient.invalidateQueries("journalVouchers"),className:"btn btn-secondary flex items-center gap-2 self-start md:self-auto",children:[e.jsx(B,{className:"h-4 w-4"}),"Refresh List"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Voucher #"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Description"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Total Debit"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Total Credit"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Lines"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[(E||O)&&e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"px-4 py-6 text-center",children:e.jsx(D,{})})}),!E&&L.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"px-4 py-6 text-center text-gray-500",children:"No journal vouchers found for the selected filters."})}),L.map(t=>{var a,s,r;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:t.voucherNumber}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:new Date(t.voucherDate).toLocaleDateString()}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:t.description||t.reference||"—"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:(a=t.totalDebit)==null?void 0:a.toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:(s=t.totalCredit)==null?void 0:s.toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:((r=t.entries)==null?void 0:r.length)||0})]},t._id)})]})]})}),J&&e.jsxs("div",{className:"mt-4 text-sm text-gray-600",children:["Showing ",L.length," of ",J.totalItems," voucher(s)"]})]})})]})};export{de as JournalVouchers,de as default};
